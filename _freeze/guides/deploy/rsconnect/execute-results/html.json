{
  "hash": "a2c9da396adb00e00a9f52e9227daa70",
  "result": {
    "markdown": "---\ntitle: \"Deploying a TensorFlow Model to RStudio Connect\"\naliases:\n  - /deploy/rsconnect/\n---\n\n\n::: callout-waring\n## Deprecation Notice\n\nStarting in [RStudio Connect 2022.09.0](https://docs.rstudio.com/connect/news/#rstudio-connect-2022090), TensorFlow model hosting is deprecated and will be removed in an upcoming release.\nUse an API framework like [Plumber](plumber.qmd), Flask, or FastAPI to create an HTTP API for your TensorFlow model.\n:::\n\nIn this tutorial you will learn how to deploy a TensorFlow model to [RStudio Connect](https://rstudio.com/products/connect/).\nRStudio Connect uses [TensorFlow Serving](https://github.com/tensorflow/serving) for performance but makes it much easier for R users to manage their deployment.\n\n## Building the model\n\nThe first thing we are going to do is to build our model.\nWe will use the Keras API to build this model.\n\nWe will use the MNIST dataset to build our model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(keras)\nlibrary(tensorflow)\nmnist <- dataset_mnist()\n\nmnist$train$x <- (mnist$train$x/255) %>%\n  array_reshape(., dim = c(dim(.), 1))\n\nmnist$test$x <- (mnist$test$x/255) %>%\n  array_reshape(., dim = c(dim(.), 1))\n```\n:::\n\n\nNow, we are going to define our Keras model, it will be a simple convolutional neural network.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- keras_model_sequential() %>%\n  layer_conv_2d(filters = 16, kernel_size = c(3,3), activation = \"relu\") %>%\n  layer_max_pooling_2d(pool_size = c(2,2)) %>%\n  layer_conv_2d(filters = 16, kernel_size = c(3,3), activation = \"relu\") %>%\n  layer_max_pooling_2d(pool_size = c(2,2)) %>%\n  layer_flatten() %>%\n  layer_dense(units = 128, activation = \"relu\") %>%\n  layer_dense(units = 10, activation = \"softmax\")\n\nmodel %>%\n  compile(\n    loss = \"sparse_categorical_crossentropy\",\n    optimizer = \"adam\",\n    metrics = \"accuracy\"\n  )\n```\n:::\n\n\nNext, we fit the model using the MNIST dataset:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel %>%\n  fit(\n    x = mnist$train$x, y = mnist$train$y,\n    batch_size = 32,\n    epochs = 5,\n    validation_sample = 0.2,\n    verbose = 2\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nEpoch 1/5\n1875/1875 - 6s - loss: 0.1714 - accuracy: 0.9486 - 6s/epoch - 3ms/step\nEpoch 2/5\n1875/1875 - 4s - loss: 0.0593 - accuracy: 0.9814 - 4s/epoch - 2ms/step\nEpoch 3/5\n1875/1875 - 4s - loss: 0.0406 - accuracy: 0.9868 - 4s/epoch - 2ms/step\nEpoch 4/5\n1875/1875 - 4s - loss: 0.0319 - accuracy: 0.9900 - 4s/epoch - 2ms/step\nEpoch 5/5\n1875/1875 - 4s - loss: 0.0256 - accuracy: 0.9918 - 4s/epoch - 2ms/step\n```\n:::\n:::\n\n\nWhen we are happy with our model accuracy in the validation dataset we can `evaluate` the results on the test dataset with:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel %>% evaluate(x = mnist$test$x, y = mnist$test$y, verbose = 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      loss   accuracy \n0.04114383 0.98680001 \n```\n:::\n:::\n\n\nOK, we have 99% accuracy on the test dataset and we want to deploy that model.\nFirst, let's save the model in the `SavedModel` format using:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsave_model_tf(model, \"cnn-mnist\")\n```\n:::\n\n\nWith the model built and saved we can now start building our plumber API file.\n\n## Deployiong to RStudio Connect\n\nOnce the model is saved to the SavedModel format, the model can be deployed with a single line of code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrsconnect::deployTFModel(\"cnn-mnist/\")\n```\n:::\n\n\nWhen the deployment is complete you will be redirected to your browser with some instructions on how to call the REST endpoint:\n\n![](images/rsc.png)\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}